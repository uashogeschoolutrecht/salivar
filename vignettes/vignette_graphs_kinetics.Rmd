---
title: "Salivary levels of secretory leukocyte protease inhibitor (SLPI) and matrix metallopeptidase 9 (MMP-9) reflect intensity and hydration status following endurance exercise - GRAPHS"
author: "Marc A.T. Teunis"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vignette_kinetics_graphs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      include = TRUE,
                      fig.width = 11,
                      fig.height = 5)
```
```{r, root}
if(!require("rprojroot")) install.packages("rprojroot", dependencies = TRUE)
library(rprojroot)
root <- rprojroot::find_root_file(criterion = is_rstudio_project)
root
```

```{r, packages}
# install.packages("gdata")
# install.packages("stargazer")
# install.packages("arm")
# library(arm)
# library(stargazer)
# library(gdata)
# library(RCurl)
# install.packages("svglite")
library(tidyverse)
library(purrr)
library(readxl)
library(readr)
library(svglite)
library(ggplot2)
library(gridExtra)
library(grid)
library(citrulliner)
library(salivar)
```

## Data load
The dataset "data_all_tidy" that is loaded here is prepared from the dataset the "raw-dataset" called "Grinta study all parameters.xlsx" generated by Knipping.
The dataset "data_order_tidy" was constructed from the MS Word file "./data-raw/order.docx" recieved from Kartaram. The dataset "analyte_annotations" contains additional information on the measured analytes in the complete study     
```{r}
## data(package = "salivar")
data(package = "salivar", "data_all_tidy")
data(package = "salivar", "data_order_tidy")
data(package = "salivar", "analyte_annotations")

```

## Check factor levels
```{r}
map(
  .x = data_all_tidy[, -5],
  .f = levels
)

## analytes 
unique(data_all_tidy$analyte)
```

## Check missing values
```{r}
sum(is.na(data_all_tidy$concentration))
naniar::vis_miss(data_all_tidy)

```

## Summarize data
```{r}
names(data_all_tidy)
data_all_tidy %>%
  na.omit() %>%
#   dplyr::filter(duplicated == "FALSE") %>%
   dplyr::group_by(protocol,
           time,
           analyte) %>%

  dplyr::summarise(mean_conc = mean(concentration),
                   sd = round(sd(concentration), digits = 3),
                   n_obs = n(),
                   sem = round(sd/sqrt(n_obs), digits = 3)) %>%
  
  dplyr::arrange(protocol, analyte) -> data_summary

```

## Select relevant analytes
```{r}
# levels(data_summary$analyte %>% as_factor)

relevant_analytes <- c(
  "slpi.se",
  "MMP-9",
  "mmp9.se",
  "SLPI"
)

data_summary_filtered <- data_summary %>%
  dplyr::filter(analyte %in% relevant_analytes)

```

## Change units
The units of measurements for MMP-9 and SLPI in serum and saliva are in pg/ml. Because this yields very large numbers we will convert the units to ug/ml
```{r}
correction <- 1000000

data_summary_filtered <- data_summary_filtered %>%
  mutate(mean_conc = mean_conc/correction,
         sd = sd/correction,
         sem = sem/correction)

```

## Split for Analytes; `purrr::nest()`
```{r}

## split for analytes
data_by_analyte <- data_summary_filtered %>%
#  as_tibble() %>%
#  gather(exam:numeracy, key = "measure", value = "value") %>%
  group_by(analyte) %>%
  nest() %>% print()

data_by_analyte$data[[1]]

```


## Split by analyte; `split()`
```{r}

data_summary_filtered$analyte <- as.factor(data_summary_filtered$analyte)
levels(data_summary_filtered$analyte)

data_split <- split(data_summary_filtered, 
                    data_summary_filtered$analyte)


```

## Set colours
```{r}
RColorBrewer::display.brewer.all()
palette <- RColorBrewer::brewer.pal(7, "Set1")
palette <- c("#000000", palette[c(1:3,4)])
```

## All lines, individually
```{r, eval=FALSE}
# define image directory
image_directory <- file.path(here::here("inst", "images", "paper"))

# argument for function test
analyte = "SLPI"

print_lines <- function(analyte, ...){

  #ymax_data <- max(data_split[[analyte]]$mean_conc)
#  sem_max <- max(data_split[[analyte]]$sem)
#  ymax <- 1.6*(ymax_data)
  
#  ymin_data <- min(data_split[[analyte]]$mean_conc)
#  ymin <- ymin_data - 1.6*(ymin_data)
  
data_plot <- data_split[[analyte]]
    
  
 plot <- citrulliner::draw_lines(DF = data_plot, 
                                 palette_graph = palette,
                                # ymax = ymax,
                                # ymin = ymin 
                                f.width = 14, f.height = 10) 
 
 


  return(plot)
}

#ala_lines
plot_list <- map(
  .x = levels(data_summary_filtered$analyte), 
  .f = print_lines)
plot_list[[1]]


names(plot_list) <- levels(data_summary_filtered$analyte)
names(plot_list)

```

## Panel plots for the paper
```{r}
library(profvis)
library(citrulliner)
library(gtable)
library(cowplot)

print_lines_panel <- function(analyte){

  ymax_data <- max(data_split[[analyte]]$mean_conc)
  sem_max <- max(data_split[[analyte]]$sem)
  ymax <- 1.05*(ymax_data)
  
  ymin_data <- min(data_split[[analyte]]$mean_conc)
  ymin <- ymin_data - (0.05*ymin_data)
  
data_plot <- data_split[[analyte]]
    
  
 plot <- citrulliner::draw_lines_panel(DF = data_plot, 
                                       palette_graph = palette, 
                                       ymax = ymax,
                                       ymin = ymin)

  

  return(plot)
}


panel_plot_list <- lapply(levels(data_summary_filtered$analyte), print_lines_panel)
names(panel_plot_list) <- levels(data_summary_filtered$analyte)
names(panel_plot_list)


```


## Select figures for panels 
```{r}

# figure 1; panel
p1_a <- panel_plot_list[["SLPI"]]
p1_b <- panel_plot_list[["slpi.se"]]
p2_a <- panel_plot_list[["MMP-9"]]
p2_b <- panel_plot_list[["mmp9.se"]]

# # figure 2; panel"
# p2_a <- panel_plot_list[["BICARB"]]
# p2_b <- panel_plot_list[["HB"]]
# p2_c <- panel_plot_list[["GLU_NS"]]
# p2_d <- panel_plot_list[["citrul"]]
# 
# figure 3
# p3_a <- panel_plot_list[["SODIUM"]]
# p3_b <- panel_plot_list[["INSULINE"]]
# p3_c <- panel_plot_list[["HT"]]
# 
# # figure 4
# p4_a <- panel_plot_list[["CHLORIDE"]]
# p4_b <- panel_plot_list[["ALB"]]
# p4_c <- panel_plot_list[["ERY"]]

```

## Fix legends, titles, scales and scientific notations
```{r}

## figure 2

p1_a <- p1_a +
  ylab("Concentration(log10(ug/ml)") +
  ggtitle("SLPI saliva") + 
  scale_y_continuous(trans='log10') +
  ylim(c(0, max(data_split[["SLPI"]]$mean_conc) + 0.1*(max(data_split[["SLPI"]]$mean_conc))))

p1_b <- p1_b + 
  ylab("Concentration(log10(ug/ml)") +
  ggtitle("SLPI serum") + 
  scale_y_continuous(trans='log10') +
  ylim(c(0, max(data_split[["SLPI"]]$mean_conc) + 0.1*(max(data_split[["SLPI"]]$mean_conc))))

p1_c <- p1_b + 
  ylab("Concentration(log10(ug/ml)") +
  ggtitle("SLPI serum") + 
  scale_y_continuous(trans='log10') +
  ylim(c(min(data_split[["slpi.se"]]$mean_conc) - 0.1*(min( data_split[["slpi.se"]]$mean_conc)), max(data_split[["slpi.se"]]$mean_conc) + 0.1*max(data_split[["slpi.se"]]$mean_conc)))


## figure 2
p2_a <- p2_a +
  ylab("Concentration(log10(ug/ml)") +
  ggtitle("MMP-9 saliva") + 
  scale_y_continuous(trans='log10') +
  ylim(c(0, max(data_split[["mmp9.se"]]$mean_conc) + 0.1*(max(data_split[["mmp9.se"]]$mean_conc))))

p2_b <- p2_b + 
  ylab("Concentration(log10(ug/ml)") +
  ggtitle("MMP-9 serum") + 
  scale_y_continuous(trans='log10') +
  ylim(c(0, max(data_split[["mmp9.se"]]$mean_conc) + 0.1*(max(data_split[["mmp9.se"]]$mean_conc))))

# p2_c <- p2_b + 
#   ylab("Concentration(log10(ug/ml)") +
#   ggtitle("MMP-9 serum") + 
#   scale_y_continuous(trans='log10') +
#   ylim(c(min(data_split[["MMP-9"]]$mean_conc) - 0.1*(min( data_split[["slpi.se"]]$mean_conc)), max(data_split[["MMP-9"]]$mean_conc) + 0.1*max(data_split[["MMP-9"]]$mean_conc)))



p1_a
p1_b 
p1_c
p2_a
p2_b 
#p2_c
```




## Panels

### Figure 1
```{r, fig.width=16, fig.height=24}
# https://cran.r-project.org/web/packages/cowplot/vignettes/shared_legends.html

figure_1 <- cowplot::plot_grid(
           p1_a + theme(legend.position="none"),
           p1_b + theme(legend.position="none"),
           p1_c + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B", "C"),
           hjust = -8,
           ncol = 1,
           nrow = 3,
           label_size = 18
           )

# figure_1

legend_b <- get_legend(p1_a + theme(legend.position="bottom"))

p_1 <- plot_grid(legend_b, figure_1, ncol = 1, rel_heights = c(0.05, 1))
p_1 %>% class

ggsave(filename = file.path(root,
                            "inst",
                            "images",
                            "paper",
                            "figure_1.svg"), plot = p_1,
       width = 30, height = 60, dpi = 250, units = "cm")
 
ggsave(filename = file.path(root,
                            "inst",
                            "images",
                            "paper",
                            "figure_1.png"), plot = p_1,
       width = 30, height = 60, dpi = 250, units = "cm")


```

### Figure 2
```{r, fig.width=16, fig.height=20}

figure_2 <- cowplot::plot_grid(
           p2_a + theme(legend.position="none"),
           p2_b + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B", "C"),
           hjust = -8,
           ncol = 1,
           nrow = 2,
           label_size = 18
           )

# figure_2

legend_b <- get_legend(p2_a + theme(legend.position="bottom"))

p_2 <- plot_grid(legend_b, figure_2, ncol = 1, rel_heights = c(0.05, 1))
p_2 %>% class

ggsave(filename = file.path(root,
                            "inst",
                            "images",
                            "paper",
                            "figure_2.svg"), plot = p_2,
       width = 25, height = 30, dpi = 250, units = "cm")
 
ggsave(filename = file.path(root,
                            "inst",
                            "images",
                            "paper",
                            "figure_2.png"), plot = p_2,
       width = 30, height = 60, dpi = 250, units = "cm")

```

